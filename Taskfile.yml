# https://taskfile.dev
version: '3'

vars:
  BACKEND_PORT: '6698'
  FRONTEND_PORT: '6699'
  BACKEND_DIR: 'backend'
  FRONTEND_DIR: 'frontend'

  # Colors
  C_RESET: '\033[0m'
  C_BOLD: '\033[1m'
  C_RED: '\033[31m'
  C_GREEN: '\033[32m'
  C_YELLOW: '\033[33m'
  C_BLUE: '\033[34m'
  C_MAGENTA: '\033[35m'
  C_CYAN: '\033[36m'
  C_WHITE: '\033[37m'
  C_GRAY: '\033[90m'

tasks:
  default:
    desc: Show available tasks
    silent: true
    cmds:
      - task: banner
      - task --list

  banner:
    desc: Show project banner
    silent: true
    cmds:
      - |
        printf "{{.C_RED}}"
        echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "  â•‘                                                               â•‘"
        echo "  â•‘   â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆâ–ˆ   â•‘"
        echo "  â•‘   â–“â–ˆ   â–€  â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ       â–ˆâ–ˆ           â–ˆâ–ˆ       â–ˆâ–ˆ â–ˆâ–ˆ  â–ˆâ–ˆ    â•‘"
        echo "  â•‘   â–“â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆ   â•‘"
        echo "  â•‘   â–“â–ˆ     â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ    â–ˆâ–ˆ â–ˆâ–ˆ    â–ˆâ–ˆ          â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ  â–ˆâ–ˆ    â•‘"
        echo "  â•‘   â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆâ–ˆ    â•‘"
        echo "  â•‘                                                               â•‘"
        echo "  â•‘             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â•‘"
        echo "  â•‘             â”‚   SAGG Â· SVETT Â· TARAR         â”‚               â•‘"
        echo "  â•‘             â”‚   The Darker Initiative         â”‚               â•‘"
        echo "  â•‘             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â•‘"
        echo "  â•‘                                                               â•‘"
        echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        printf "{{.C_RESET}}"
        echo ""
        printf "{{.C_GRAY}}  â›“ï¸  From the Shadows of BST{{.C_RESET}}\n"
        echo ""

  status:
    desc: Check if backend/frontend are running
    silent: true
    cmds:
      - task: banner
      - |
        printf "{{.C_BOLD}}SERVICE STATUS{{.C_RESET}}\n"
        printf "{{.C_GRAY}}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€{{.C_RESET}}\n"
        
        # Check Backend
        printf "Backend ({{.BACKEND_PORT}})   "
        if pgrep -f "uvicorn src.main:app" > /dev/null; then
          printf "{{.C_GREEN}}â— Online{{.C_RESET}}\n"
        else
          printf "{{.C_RED}}â—‹ Offline{{.C_RESET}}\n"
        fi

        # Check Frontend
        printf "Frontend ({{.FRONTEND_PORT}})  "
        if pgrep -f "next-server" > /dev/null || pgrep -f "bun run dev" > /dev/null; then
          printf "{{.C_GREEN}}â— Online{{.C_RESET}}\n"
        else
          printf "{{.C_RED}}â—‹ Offline{{.C_RESET}}\n"
        fi
        
        printf "{{.C_GRAY}}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€{{.C_RESET}}\n"
        
        # Check Ports
        if lsof -i :{{.BACKEND_PORT}} -t >/dev/null 2>&1; then
          printf "Port {{.BACKEND_PORT}}:       {{.C_YELLOW}}In Use{{.C_RESET}}\n"
        fi
        if lsof -i :{{.FRONTEND_PORT}} -t >/dev/null 2>&1; then
          printf "Port {{.FRONTEND_PORT}}:       {{.C_YELLOW}}In Use{{.C_RESET}}\n"
        fi
        echo ""

  dev:
    desc: Start both backend and frontend
    deps: [stop]
    silent: true
    cmds:
      - task: banner
      - echo "ğŸŒ‘ Awakening the darkness..."
      - echo ""
      - 'printf "Backend:  {{.C_CYAN}}http://localhost:{{.BACKEND_PORT}}{{.C_RESET}}\n"'
      - 'printf "Frontend: {{.C_CYAN}}http://localhost:{{.FRONTEND_PORT}}{{.C_RESET}}\n"'
      - echo ""
      - 'printf "{{.C_YELLOW}}â›” Press Ctrl+C to return to the void{{.C_RESET}}\n"'
      - echo ""
      - |
        # Start backend
        (cd {{.BACKEND_DIR}} && uv run uvicorn src.main:app --reload --port {{.BACKEND_PORT}}) &
        BACKEND_PID=$!
        sleep 2
        # Start frontend
        (cd {{.FRONTEND_DIR}} && bun run dev) &
        FRONTEND_PID=$!
        # Wait for processes and clean up on exit
        wait $BACKEND_PID $FRONTEND_PID
        task stop

  dev-backend:
    desc: Start backend only (port {{.BACKEND_PORT}})
    silent: true
    cmds:
      - task: banner
      - 'printf "{{.C_BLUE}}ğŸ”§ Summoning backend on http://localhost:{{.BACKEND_PORT}}{{.C_RESET}}\n"'
      - pkill -9 -f "uvicorn src.main:app" 2>/dev/null || true
      - sleep 1
      - cd {{.BACKEND_DIR}} && uv run uvicorn src.main:app --reload --port {{.BACKEND_PORT}}

  dev-frontend:
    desc: Start frontend only (port {{.FRONTEND_PORT}})
    silent: true
    cmds:
      - task: banner
      - 'printf "{{.C_MAGENTA}}ğŸŒ Manifesting frontend on http://localhost:{{.FRONTEND_PORT}}{{.C_RESET}}\n"'
      - pkill -9 -f "next-server" 2>/dev/null || true
      - pkill -9 -f "bun run dev" 2>/dev/null || true
      - sleep 1
      - cd {{.FRONTEND_DIR}} && bun run dev

  stop:
    desc: Stop all running services
    silent: true
    cmds:
      - printf "{{.C_RED}}ğŸ›‘ Stopping services...{{.C_RESET}}\n"
      - pkill -9 -f "uvicorn src.main:app" 2>/dev/null || true
      - pkill -9 -f "next-server" 2>/dev/null || true
      - pkill -9 -f "bun run dev" 2>/dev/null || true
      - printf "{{.C_GREEN}}âœ… All services stopped{{.C_RESET}}\n"

  clean:
    desc: Clean caches and stop services
    deps: [stop]
    silent: true
    cmds:
      - 'printf "{{.C_YELLOW}}ğŸ§¹ Cleaning caches...{{.C_RESET}}\n"'
      - find {{.BACKEND_DIR}} -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
      - rm -rf {{.FRONTEND_DIR}}/.next {{.FRONTEND_DIR}}/node_modules/.cache 2>/dev/null || true
      - 'printf "{{.C_GREEN}}âœ… Caches cleaned{{.C_RESET}}\n"'

  clean-deep:
    desc: Deep clean (removes dependencies)
    deps: [clean]
    silent: true
    cmds:
      - 'printf "{{.C_RED}}ğŸ§¹ Deep cleaning (removes dependencies)...{{.C_RESET}}\n"'
      - rm -rf {{.BACKEND_DIR}}/.venv
      - rm -rf {{.FRONTEND_DIR}}/node_modules
      - 'printf "{{.C_GREEN}}âœ… Deep clean complete{{.C_RESET}}\n"'
      - 'printf "{{.C_YELLOW}}âš ï¸  Run "task setup" to reinstall dependencies{{.C_RESET}}\n"'

  setup:
    desc: Install dependencies
    silent: true
    cmds:
      - 'printf "{{.C_BLUE}}ğŸ“¦ Installing dependencies...{{.C_RESET}}\n"'
      - cd {{.BACKEND_DIR}} && uv sync
      - cd {{.FRONTEND_DIR}} && bun install
      - 'printf "{{.C_GREEN}}âœ… Dependencies installed{{.C_RESET}}\n"'

  restart:
    desc: Stop and restart both services
    deps: [stop]
    silent: true
    cmds:
      - sleep 1
      - task dev

  check:
    desc: Quick health check (curl endpoints)
    silent: true
    cmds:
      - 'printf "{{.C_BOLD}}ğŸ¥ Running health checks...{{.C_RESET}}\n"'
      - echo ""
      - 'printf "Backend API: "'
      - 'curl -s http://localhost:{{.BACKEND_PORT}}/api/episodes | head -c 100 > /dev/null && printf "{{.C_GREEN}}âœ… Online{{.C_RESET}}\n" || printf "{{.C_RED}}âŒ Not responding{{.C_RESET}}\n"'
      - 'printf "Frontend:    "'
      - 'curl -s http://localhost:{{.FRONTEND_PORT}} | head -c 100 > /dev/null && printf "{{.C_GREEN}}âœ… Online{{.C_RESET}}\n" || printf "{{.C_RED}}âŒ Not responding{{.C_RESET}}\n"'
      - echo ""

  verify:
    desc: Full verification (lint + typecheck + build)
    silent: true
    cmds:
      - 'printf "{{.C_BOLD}}âœ… Running full verification...{{.C_RESET}}\n"'
      - echo ""
      - 'printf "{{.C_BLUE}}=== Backend Linting ==={{.C_RESET}}\n"'
      - cd {{.BACKEND_DIR}} && uv run ruff check .
      - echo ""
      - 'printf "{{.C_MAGENTA}}=== Frontend TypeScript ==={{.C_RESET}}\n"'
      - cd {{.FRONTEND_DIR}} && bun run typecheck
      - echo ""
      - 'printf "{{.C_MAGENTA}}=== Frontend Build ==={{.C_RESET}}\n"'
      - cd {{.FRONTEND_DIR}} && bun run build
      - echo ""
      - 'printf "{{.C_GREEN}}âœ… All verification passed!{{.C_RESET}}\n"'

  logs:
    desc: Tail logs from services
    silent: true
    cmds:
      - 'printf "{{.C_YELLOW}}ğŸ“œ Tailing logs (Ctrl+C to exit)...{{.C_RESET}}\n"'
      - 'printf "{{.C_GRAY}}Note: This works best if services are running in background{{.C_RESET}}\n"'
      - tail -f {{.BACKEND_DIR}}/logs/*.log 2>/dev/null || echo "No log files found"

  migrate:
    desc: Run database migrations
    silent: true
    cmds:
      - 'printf "{{.C_BLUE}}ğŸ“Š Running database migrations...{{.C_RESET}}\n"'
      - cd {{.BACKEND_DIR}} && alembic upgrade head
      - 'printf "{{.C_GREEN}}âœ… Migrations complete{{.C_RESET}}\n"'

  migrate-create:
    desc: Create new migration (usage- task migrate-create MSG='description')
    silent: true
    cmds:
      - |
        if [ -z "{{.MSG}}" ]; then
          printf "{{.C_RED}}âŒ Usage: task migrate-create MSG='your migration description'{{.C_RESET}}\n"
          exit 1
        fi
        printf "{{.C_BLUE}}ğŸ“ Creating migration: {{.MSG}}{{.C_RESET}}\n"
        cd {{.BACKEND_DIR}} && alembic revision --autogenerate -m "{{.MSG}}"
    requires:
      vars: [MSG]
